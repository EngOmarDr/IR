<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Information Retrieval System</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .result { margin-bottom: 10px; }
        .score { color: green; }
        select, input[type="text"] { padding: 8px; margin: 5px; width: 300px; }
        #suggestions {
            border: 1px solid #ccc;
            max-width: 300px;
            position: absolute;
            background: white;
            z-index: 100;
        }
        #suggestions div {
            padding: 5px;
            cursor: pointer;
        }
        #suggestions div:hover {
            background-color: #e0e0e0;
        }
        .rag-answer {
            margin-top: 20px;
            padding: 15px;
            background: #f0f8ff;
            border-left: 4px solid #2196F3;
        }
        .rag-context {
            margin-top: 10px;
            padding: 15px;
            background: #fff8dc;
            border-left: 4px solid #ffa500;
        }
        .context-item {
            margin-bottom: 10px;
        }
        h3 { margin-top: 30px; }
    </style>
</head>
<body>
    <h1>🔍 Information Retrieval System</h1>
    <form method="POST" autocomplete="off" style="position: relative;">
        <label>Choose Dataset:</label><br>
        <select name="dataset">
            {% for ds in datasets %}
                <option value="{{ ds }}" {% if ds == selected_dataset %}selected{% endif %}>{{ ds }}</option>
            {% endfor %}
        </select><br>

        <label>Choose Representation:</label><br>
        <select name="representation">
            {% for rep in representations %}
                <option value="{{ rep }}" {% if rep == selected_representation %}selected{% endif %}>{{ rep }}</option>
            {% endfor %}
        </select><br>

        <label>Enter your query:</label><br>
        <input type="text" name="query" id="query-input" value="{{ query }}" required>
        <div id="suggestions"></div><br>

        <label><input type="checkbox" name="enable_rag" {% if rag_enabled %}checked{% endif %}> تفعيل الإجابة التوليدية (RAG)</label><br>
        <label><input type="checkbox" name="enable_suggestions" {% if suggestions_enabled %}checked{% endif %}> تفعيل اقتراحات الاستعلام</label><br><br>

        <button type="submit">Search</button>
    </form>

    {% if rag_answer %}
        <div class="rag-answer">
            <h3>💡 Generated Answer (RAG):</h3>
            <p>{{ rag_answer }}</p>
        </div>

        {% if results %}
        <div class="rag-context">
            <h3>📚 Context Used for Answer:</h3>
            {% for item in results[:3] %}
                <div class="context-item">- {{ item.text }}</div>
            {% endfor %}
        </div>
        {% endif %}
    {% endif %}

    {% if results %}
        <h2>Results for <i>{{ selected_representation }}</i></h2>
        <ol>
            {% for item in results %}
                <li>
                    <div class="result">
                        <b>ID:</b> {{ item.doc_id }}<br>
                        <b>Text:</b> {{ item.text }}<br>
                        <b class="score">Score:</b> {{ item.score|round(4) }}
                    </div>
                </li>
            {% endfor %}
        </ol>
    {% endif %}

    <script>
    const suggestionsEnabled = {{ 'true' if suggestions_enabled else 'false' }};
    const input = document.getElementById('query-input');
    const suggestionsBox = document.getElementById('suggestions');

    if (suggestionsEnabled) {
        input.addEventListener('input', () => {
            const val = input.value.trim();
            if (val.length < 2) {
                suggestionsBox.innerHTML = '';
                return;
            }

            fetch(`/suggest?q=${encodeURIComponent(val)}`)
                .then(response => response.json())
                .then(data => {
                    suggestionsBox.innerHTML = '';
                    data.forEach(s => {
                        const div = document.createElement('div');
                        div.textContent = s;
                        div.onclick = () => {
                            input.value = s;
                            suggestionsBox.innerHTML = '';
                        };
                        suggestionsBox.appendChild(div);
                    });
                })
                .catch(() => {
                    suggestionsBox.innerHTML = '';
                });
        });

        document.addEventListener('click', e => {
            if (e.target !== input) {
                suggestionsBox.innerHTML = '';
            }
        });
    } else {
        suggestionsBox.innerHTML = '';
    }
    </script>
</body>
</html>
